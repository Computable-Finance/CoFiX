# CoFiX兑换协议产品文档

## 1、简介
本文档是对“CoFiX：一种可计算的金融交易模型” 白皮书所描述的金融交易模型的实现设计。主要包括价格计算、交易、做市商、异常处理等机制和前端页面交互定义。

## 2、系统角色

角色 | 定义
---|---
交易者 | 参与 CoFiX 交易的对象，可以是某个以太坊钱包或者合约地址
做市商 | 参与 CoFiX 做市的对象，是交易者的对手盘，为交易提供流动性，可以是某个以太坊钱包地址或者合约地址
治理者 | 参与 CoFiX系统治理的对象，是 CoFiX的治理代币持有者，通过发起投票修改和升级 CoFiX系统。（前期由管理员多签账户代理）

## 3、价格计算机制  

### 3.1、价格来源

CoFiX 协议的价格来源于 NEST 预言机，每个交易池对应一个 NEST 预言机价格源，例如：

ETH: USDT 交易池，价格从 NEST 的 ETH/USDT 预言机调用。

ETH：HBTC 交易池，价格从 NEST 的 ETH/HBTC 预言机调用。

在NEST系统里，一个报价对对应一个预言机，详见NEST预言机文档。

### 3.2、价格补偿系数K

由于 NEST 价格和均衡价格存在一定的偏差和延时(可以理解成去中心化的成本)，因 此 CoFiX 在应用该价格时需要对风险给出一些补偿，确保做市商有动力持续做市。补偿系数记为 K，该系数与波动率σ和延时变量 T 有关，当交易者进行交易时，并不是直接使用NEST价格 P，而是使用 ：

买入时：![](http://latex.codecogs.com/svg.latex?P_{b}^{'}=P*(1+K))

或者

卖出时：![](http://latex.codecogs.com/svg.latex?P_{s}^{'}=P*(1-K))

这里的买入和卖出都是相对价格P所对应的本位资产来说的，例如价格P是以ETH为本位的， 即一单位ETH等于多少USDT、HBTC等资产，则买入和卖出指的是买入和卖出ETH（卖出时其实就是买入本位资产所对应的另一方资产）。

同样做市商在进入和退出做市时，计算净值用 的价格变量也是![](http://latex.codecogs.com/svg.latex?{P}\')而不是 P，这一价格称之为交易价格。详细计算方式见附录“CoFiX价格偏差系数（K）计算说明”

### 3.3、预估价格和执行价格

由于以太坊一笔交易由发起到执行需要一定的等待时间，并且 NEST 预言机价格一直处于更新状态，因此交易发起和实际交易打包成功时的价格会存在一定的差异。这里我们先定义一下预估价格和执行价格。


 价格 | 说明
---|---
预估价格：![](http://latex.codecogs.com/svg.latex?P_{es})| 用户或者做市商在发起交易时看到的参照价格，取自 NEST 预言机最新历史价格。这个价格主要是前端用来进行交易价格展示以及兑换金额、认购份额、赎回资产数量的预估计算。
执行价格：![](http://latex.codecogs.com/svg.latex?P_{ex})| 交易执行时，实际调用的 NEST 预言机最新价格。

由预估价格和执行价格可以计算实际成交价差![](http://latex.codecogs.com/svg.latex?P_{d})：

![](http://latex.codecogs.com/svg.latex?P_{d}=\left|P_{ex}-P_{es}&space;\right|/P_{es})

当前设定当![](http://latex.codecogs.com/svg.latex?P_{d}>1%)时发出的交易会被revert

### 3.4、预言机价格调用费

当向 CoFiX 发起交易、赎回、认购操作时，会向 NEST Protocol 调用预言机价格、因此用户需要向预言机支付对应的调用费，收费标准取决于 NEST Protocol，目前调价格的收费是 0.01 ETH。
